name: android-cross-build

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
  merge_group:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        # abi: [arm64-v8a, armeabi-v7a, x86_64]
        abi: [arm64-v8a]
        api: [21]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build git ca-certificates python3 \
            build-essential make

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
            distribution: temurin
            java-version: '17'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Install NDK (side by side)
        shell: bash
        run: |
            # yes | sdkmanager --licenses
            sdkmanager "ndk;26.1.10909125"

      - name: Use host env to compile protoc
        shell: bash
        run: |
          git submodule update --init
          cmake -S . -B build-host -G Ninja
          cmake --build build-host --target protoc --parallel

      - name: Configure (CMake)
        shell: bash
        run: |
          git submodule foreach --recursive 'git stash --include-untracked'

          export ANDROID_SDK_ROOT="$ANDROID_HOME"
          export ANDROID_NDK_HOME="$ANDROID_SDK_ROOT/ndk/26.1.10909125"

          cmake -S . -B build-android-${{ matrix.abi }} -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api }} \
            -DANDROID_STL=c++_shared \
            -DBUILD_PYTHON_BINDINGS=OFF \
            -DBUILD_TOOLS=OFF \
            -DGLOBAL_CC_PROTOBUF_PROTOC="$GITHUB_WORKSPACE/build-host/bin/protoc" \

      - name: Build
        shell: bash
        run: |
          cmake --build build-android-${{ matrix.abi }} --parallel

      - name: Build examples
        shell: bash
        run: |
          cd examples/c++
          
          cmake -S . -B  build-android-examples-${{ matrix.abi }} -D Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api }} \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DHOST_BUILD_DIR="build-android-${{ matrix.abi }}" \
          
          cmake --build build-android-examples-${{ matrix.abi }} --parallel

      - name: Install ADB and setup Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api }}
          abi: ${{ matrix.abi }}
          script: |
            # Wait for device to be ready
            adb wait-for-device
            
            # Push executables to device
            adb push examples/c++/build-android-examples-${{ matrix.abi }}/ailego-example /data/local/tmp/
            adb push examples/c++/build-android-examples-${{ matrix.abi }}/core-example /data/local/tmp/
            adb push examples/c++/build-android-examples-${{ matrix.abi }}/db-example /data/local/tmp/
            
            # Make executables executable
            adb shell chmod +x /data/local/tmp/ailego-example
            adb shell chmod +x /data/local/tmp/core-example
            adb shell chmod +x /data/local/tmp/db-example
            
            echo "Running ailego example:"
            adb shell 'cd /data/local/tmp/ && ./ailego-example'
            echo "Exit code: $?"
            
            echo "Running core example:"
            adb shell 'cd /data/local/tmp/ && ./core-example'
            echo "Exit code: $?"
            
            echo "Running db example:"
            adb shell 'cd /data/local/tmp/ && ./db-example'
            echo "Exit code: $?"
